<div class="room-content flowchart-room">
    <div class="room-container p-6 fade-in">
        <div class="text-center mb-6">
            <i class="bi bi-diagram-3 text-6xl text-blue-500 animate-pulse"></i>
            <h2 class="text-3xl font-bold mt-4 text-blue-400">FLOWCHART CONSTRUCTION LAB</h2>
            <p class="text-gray-300 mt-2">Learn to create proper flowcharts step by step!</p>
        </div>
        
        <div class="defense-status grid grid-cols-3 gap-4 mb-6">
            <div class="status-card bg-green-900 p-4 rounded text-center">
                <i class="bi bi-check-circle text-green-400 text-2xl"></i>
                <p class="text-sm text-green-200">Learning Progress</p>
                <p id="completion-score" class="text-2xl font-bold text-green-100">0%</p>
                <p class="text-xs text-yellow-400">LEARNING</p>
            </div>
            <div class="status-card bg-purple-900 p-4 rounded text-center">
                <i class="bi bi-puzzle text-purple-400 text-2xl"></i>
                <p class="text-sm text-purple-200">Current Level</p>
                <p id="current-level" class="text-2xl font-bold text-purple-100">1/5</p>
                <p class="text-xs text-purple-300">Progress Tracking</p>
            </div>
            <div class="status-card bg-red-900 p-4 rounded text-center">
                <i class="bi bi-heart-fill text-red-400 text-2xl"></i>
                <p class="text-sm text-red-200">Attempts Left</p>
                <p id="attempts-left" class="text-2xl font-bold text-red-100">3</p>
                <p class="text-xs text-red-300">Remaining Tries</p>
            </div>
        </div>

        <div class="challenge-content bg-gray-700 p-6 rounded-lg">
            <div class="flex gap-4 mb-4">
                <!-- Flowchart Canvas -->
                <div class="game-area-container bg-black rounded-lg p-4 flex-1">
                    <h4 class="text-white font-bold mb-3 text-center">üîÑ Flowchart Canvas</h4>
                    <div id="defense-game" class="relative bg-gray-900 rounded" style="width: 800px; height: 600px; margin: 0 auto; border: 2px solid #4299e1;">
                        <!-- Grid background will be added via JavaScript -->
                        <div class="canvas-instructions" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: rgba(255, 255, 255, 0.5); pointer-events: none;">
                            <i class="bi bi-cursor" style="font-size: 3rem; margin-bottom: 10px; display: block;"></i>
                            <p>Select a tool from the palette, then click here to place flowchart elements</p>
                        </div>
                    </div>
                </div>
                
                <!-- Tool Palette -->
                <div class="tool-palette bg-gray-800 rounded-lg p-4" style="width: 200px;">
                    <h4 class="text-white font-bold mb-3 text-center">üõ†Ô∏è Tools</h4>
                    <div id="flowchart-tools" class="space-y-2">
                        <!-- Tools will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Instructions Panel -->
            <div class="instruction-panel bg-gray-800 p-4 rounded-lg mb-4">
                <div class="flex items-start gap-4 mb-3">
                    <div class="scenario-info flex-1">
                        <h4 class="text-white font-bold mb-2 flex items-center">
                            üìã <span id="scenario-title" class="ml-2">Sarah's Coffee Shop Opening</span>
                        </h4>
                        <div class="scenario-context bg-gray-700 p-3 rounded mb-3">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-blue-400 font-bold">üé≠ Scenario:</span>
                                <span id="scenario-name" class="text-blue-300">Coffee Shop Process Flow</span>
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-green-400 font-bold">üë§ Character:</span>
                                <span id="character-name" class="text-green-300">Sarah - Cafe Owner</span>
                            </div>
                            <div class="text-gray-300 text-sm">
                                <span class="text-purple-400 font-bold">üìñ Story:</span>
                                <p id="scenario-story" class="mt-1">Sarah is opening her first coffee shop and needs a simple process flowchart for her opening day routine. Help her create a basic flow that shows how she starts and ends her day.</p>
                            </div>
                        </div>
                        <div class="task-instruction bg-blue-900 p-3 rounded">
                            <p class="text-blue-200 font-bold mb-1">üéØ Your Task:</p>
                            <p id="current-instruction" class="text-gray-300 text-sm">Create Sarah's opening day flowchart: START ‚Üí END (with proper connections)</p>
                        </div>
                    </div>
                </div>
                <div class="hint-section bg-gray-700 p-3 rounded">
                    <span class="text-xs text-gray-400">üí° Hint: </span>
                    <span id="current-hint" class="text-xs text-blue-300">Every business process needs a clear beginning and end. Use oval shapes for START and END points.</span>
                </div>
            </div>
            
            <div class="control-buttons text-center mb-4">
                <button id="complete-level" class="bg-green-600 hover:bg-green-700 px-6 py-2 rounded-lg text-sm transition-colors mr-2">
                    <i class="bi bi-check-square"></i> Complete Level
                </button>
                <button id="abort-mission" class="bg-red-600 hover:bg-red-500 px-6 py-2 rounded-lg text-sm transition-colors mr-2">
                    <i class="bi bi-x-circle"></i> Exit Lab
                </button>
                <button id="get-hint" class="bg-yellow-600 hover:bg-yellow-700 px-6 py-2 rounded-lg text-sm transition-colors mr-2">
                    <i class="bi bi-lightbulb"></i> Get Hint
                </button>
                <button id="reset-canvas" class="bg-orange-600 hover:bg-orange-700 px-6 py-2 rounded-lg text-sm transition-colors mr-2">
                    <i class="bi bi-arrow-clockwise"></i> Reset Canvas
                </button>
            </div>
            
            <div class="instructions text-center text-sm text-gray-400">
                <p class="mb-2">üéØ Create flowcharts following the scenario instructions</p>
                <p class="mb-2">üîÑ Select tools from the palette and click on canvas to place elements</p>
                <p class="mb-2">üîó Use the arrow tool to connect nodes by clicking between them</p>
                <p class="text-yellow-300">‚ö†Ô∏è <strong>Required:</strong> Connect all nodes with arrows to complete the level!</p>
            </div>
        </div>
    </div>
</div>

<script type="module">
// Initialize the flowchart game when this room loads
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize if we haven't already and we have the required elements
    if (!window.flowchartGame && document.getElementById('defense-game')) {
        // Load the flowchart game script if not already loaded
        if (!window.FlowchartGame) {
            const script = document.createElement('script');
            script.src = '/static/js/flowchart-game.js';
            script.type = 'module';
            script.onload = () => {
                if (window.FlowchartGame) {
                    window.flowchartGame = new window.FlowchartGame();
                    console.log('Flowchart game initialized from room HTML');
                }
            };
            document.head.appendChild(script);
        } else {
            // FlowchartGame class already exists, initialize it
            window.flowchartGame = new window.FlowchartGame();
            console.log('Flowchart game initialized from existing class');
        }
    }
});

// Set up the game immediately if DOM is already loaded
if (document.readyState !== 'loading') {
    if (!window.flowchartGame && document.getElementById('defense-game')) {
        if (!window.FlowchartGame) {
            const script = document.createElement('script');
            script.src = '/static/js/flowchart-game.js';
            script.type = 'module';
            script.onload = () => {
                if (window.FlowchartGame) {
                    window.flowchartGame = new window.FlowchartGame();
                    console.log('Flowchart game initialized immediately');
                }
            };
            document.head.appendChild(script);
        } else {
            window.flowchartGame = new window.FlowchartGame();
            console.log('Flowchart game initialized from existing class immediately');
        }
    }
}
</script>

<style>
.flowchart-room {
    height: 100%;
    color: #ffffff;
}

.room-container {
    height: 100%;
    overflow-y: auto;
}

.fade-in {
    animation: fadeIn 0.5s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.defense-status {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.status-card {
    padding: 1rem;
    border-radius: 0.5rem;
    text-align: center;
}

.challenge-content {
    background-color: rgb(55, 65, 81);
    padding: 1.5rem;
    border-radius: 0.5rem;
}

.game-area-container {
    background-color: #000;
    border-radius: 0.5rem;
    padding: 1rem;
    flex: 1;
}

.tool-palette {
    background-color: rgb(31, 41, 55);
    border-radius: 0.5rem;
    padding: 1rem;
    width: 200px;
}

.tool-item {
    padding: 0.75rem;
    border-radius: 0.375rem;
    cursor: pointer;
    border: 2px solid rgb(75, 85, 99);
    transition: all 0.3s;
    margin-bottom: 0.5rem;
}

.tool-item:hover {
    border-color: rgb(96, 165, 250);
}

.instruction-panel {
    background-color: rgb(31, 41, 55);
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

.scenario-context {
    background-color: rgb(55, 65, 81);
    padding: 0.75rem;
    border-radius: 0.375rem;
    margin-bottom: 0.75rem;
}

.task-instruction {
    background-color: rgb(30, 58, 138);
    padding: 0.75rem;
    border-radius: 0.375rem;
}

.hint-section {
    background-color: rgb(55, 65, 81);
    padding: 0.75rem;
    border-radius: 0.375rem;
}

.control-buttons {
    text-align: center;
    margin-bottom: 1rem;
}

.control-buttons button {
    margin-right: 0.5rem;
    padding: 0.5rem 1.5rem;
    border-radius: 0.5rem;
    border: none;
    transition: all 0.3s;
    cursor: pointer;
    font-size: 0.875rem;
}

.flowchart-node {
    position: absolute;
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}

#defense-game {
    position: relative;
    background-color: rgb(17, 24, 39);
    border-radius: 0.375rem;
    border: 2px solid rgb(66, 153, 225);
}

.instructions {
    text-align: center;
    font-size: 0.875rem;
    color: rgb(156, 163, 175);
}

.defense-success {
    text-align: center;
    padding: 2rem;
}

.final-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.victory-report {
    background-color: rgb(31, 41, 55);
    padding: 1rem;
    border-radius: 0.375rem;
    margin-bottom: 1rem;
}

.animate-bounce {
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% {
        transform: translateY(-25%);
        animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
    }
    50% {
        transform: translateY(0);
        animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
    }
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: .5;
        font-size: 3rem;
        transform: scale(1.1);

}
}

.canvas-controls {
    display: flex;
    gap: 10px;
    justify-content: center;
}

.btn-primary, .btn-secondary, .btn-hint {
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #28a745;
    color: white;
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-hint {
    background: #ffc107;
    color: #000;
}

.btn-primary:hover, .btn-secondary:hover, .btn-hint:hover {
    transform: translateY(-2px);
}

.instructions-panel {
    width: 300px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    padding: 20px;
    border: 2px solid rgba(0, 95, 251, 0.3);
}

.instructions-panel h3 {
    margin-top: 0;
    color: #005FFB;
}

.instruction-steps {
    margin-bottom: 20px;
}

.step {
    display: flex;
    gap: 12px;
    margin-bottom: 15px;
    align-items: flex-start;
}

.step-number {
    background: #005FFB;
    color: white;
    width: 25px;
    height: 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.9rem;
    flex-shrink: 0;
}

.expected-flow {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 15px;
}

.expected-flow h4 {
    color: #28a745;
    margin-bottom: 10px;
}

.success-modal, .hint-modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
}

.modal-content {
    background: rgba(13, 26, 44, 0.95);
    border: 2px solid #28a745;
    border-radius: 15px;
    padding: 30px;
    text-align: center;
    max-width: 500px;
    width: 90%;
}

.success-animation i {
    font-size: 4rem;
    color: #28a745;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

.score-display {
    margin: 20px 0;
}

.score {
    display: block;
    font-size: 2rem;
    color: #ffc107;
    font-weight: bold;
}

.badge-earned {
    color: #28a745;
    font-size: 1.1rem;
}

.hint-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.close-btn {
    background: none;
    border: none;
    color: #ffffff;
    font-size: 1.5rem;
    cursor: pointer;
}

</style>


